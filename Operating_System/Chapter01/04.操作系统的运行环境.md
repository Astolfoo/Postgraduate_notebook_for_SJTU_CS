操作系统的主要运行环境包括系统的硬件环境和由其他的系统软件组成的软件环境，以及操作系统和使用他的人之间的关系。


## 中央处理器（CPU）
### 1.单处理器与多处理器系统

单处理器系统：计算机有一个CPU

多处理器系统：计算机有多个CPU。


### 2.CPU的构成与基本工作方式
处理器由运算器、控制器、一系列的寄存器以及高速缓存构成。

      运算器：实现指令中的算术和逻辑运算，是计算机计算的核心。
      
      控制器：负责控制程序运行的流程，包括取指令、维护CPU状态、CPU与内存的交互等。
      
      寄存器：是指令在CPU内部做处理的过程中暂存数据、地址以及指令信息的存储设备，在计算机的存储系统中它具有最快的访问速度。
      
      高速缓存：处于CPU和物理内存之间
           1）.一般由控制器中的内存管理单元（MMU：Memory Management Unit）管理；
           2）.访问速度快于内存，低于寄存器；
           3）.通过高速缓存可以使得CPU的高速指令处理和低速内存访问得以匹配，从而提高CPU的效率。

## 指令系统
每台计算机机器指令的集合称为指令系统，它能够反应一台机器的功能和处理能力，可以分为以下五类：
   
   - 数据处理类指令：用于执行算术和逻辑运算
   - I/O指令：用于启动外围设备，让主存和设备交换数据。
   - 寄存器数据交换类指令：用于在处理器的寄存器和存储器之间交换数据。
   - 控制类指令：如转移，用于改变执行指令序列。
   - 处理器控制指令：修改处理器状态，改变处理器工作方式。
   
专门设计了一系列基本机制：

      具有特权级别的处理器状态，能在不同特权级别运行的各个特权指令。
      硬件机制使得OS可以和普通程序隔离，实现保护和控制。


### 3.处理器中的寄存器

两类寄存器：

   用户可见寄存器（工作寄存器）：由处理器执行的机器语言来引用，通常是对所有的程序都是可用的，包括系统程序和用户程序。
        
        机器语言直接引用
        
        包括了数据寄存器、地址寄存器以及条件码寄存器
        
        数据寄存器(Data Register):又称为通用寄存器，主要用于各种算术逻辑指令和访存指令。
        
        地址寄存器（Address Register）:用于存储数据及指令的物理地址、线性地址或者是有效地址，用于某种特定方式的地址，如索引寄存器（Index Register）、段寄存器（Segment Pointer）、栈指针（Stack Pointer）。
        
        条件码寄存器：保存CPU操作结果的各种标记位，如算术运算过程中产生的溢出、符号等。
        
   控制和状态寄存器：用户控制处理器的操作，大部分对用户是不可见的，由OS的特权代码使用。
        
        用于控制处理器的操作
        
        对于部分用户是不可见的。
        
        一部分可以在某种特权模式（由OS使用）下访问的控制和状态寄存器：
        
        程序计数器（PC，Program Counter）：记录将要取出的指令的地址。
        
        指令寄存器（IR，Instruction Register）：包含最近取出的指令。
        
        程序状态字（PSW，Program Status Word）：记录处理器的运行模式信息等。

## 特权指令和非特权指令
特权指令：只能由操作系统使用的指令。例如：

   - 启动某设备
   - 设置时钟
   - 允许和禁止中断
   - 清内存
   - 在进程之间切换处理机
   - 建立存储保护
   - 存取用于内存保护的寄存器
   - 执行输入输出操作
   - 停止一个CPU的工作
   
非特权指令：在单用户单任务的环境下，不必对指令进行划分。

**用户只能使用非特权指令，只有操作系统OS才可以使用所有的指令（包括非特权指令）。**

使用多道程序设计技术的计算机指令系统必须要区分特权指令和非特权指令。

特权指令一般引起处理器状态的切换：

   - 处理器通过特殊的机制将处理器的状态切换到操作系统运行的特权状态（管态）。
   - 然后将处理权移交给操作系统中的一段特殊代码，这个过程叫做陷入。
   

### 4.处理器的状态       

根据运行程序对资源和机器指令的使用权限将处理器设置为不同的状态：

3.1 多数系统将处理器工作状态划分为**管态**和**目态**。

        管态：操作系统管理程序运行的状态，又称为特权态、系统态、管理态或核心态。
        
        目态：用户程序运行时的状态，又称为普通态或者用户态。
        
3.2 有些系统将处理器状态划分为核心状态、管理状态和用户程序状态（目标状态）三种情况。


**3.3 管态和目态的差别**

处理器处于管态时：

   - 可以执行全部指令（包括特权指令）
   - 可使用所有资源
   - 具有改变处理器状态的能力
   
处理器处于目态时：

   - 只有非特权指令能够执行。

特权级别不同，可运行指令集合就不同。

特权级别越高，可以运行指令集合越大。

搞特权级别对应的可运行指令集合包含低特权级别的。

3.4 管态和目态的切换

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/03.png)

### 5.程序状态字（PSW，Program Status Word）
在PSW中专门设置一位，根据运行程序使用指令的权限而设置：

CPU的工作状态码——————指明管态还是目态，用来说明当前在CPU上执行的是操作系统还是一般用户，从而决定其是否可以使用特权指令或者是拥有其他的特殊权力。

条件码——————反映指令执行后的结果特征

中断屏蔽码————指出是否允许中断。

**5.1 微处理器M68000的程序状态字**

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/04.PNG)

**5.2 微处理器Intel 80386的程序状态字**

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/05.PNG)


### 6.主存储器(支持OS运行的硬件环境的一个重要的方面)
6.1 一个作业必须把它的程序和数据存放到主存储器中才可以运行。

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/06.PNG)

6.2 存储器的类型

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/07.PNG)

6.3 ROM和RAM的用途

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/08.PNG)

6.4 存储分块

存储的最小单位称为“二进制”，包含的信息为0或者1.存储器最小单位编址单位是字节，有8位，两个字节组成一个“字”。

把存储器分为“块”便于管理分配，在为用户分配主存空间时，以块为最小单位。

            16字节（一块）————————————————PC机
            64字节（一块）————————————————PDP-11机
            2k字节（一块）————————————————IBM370机、IBM大型机
            
6.5 存储保护

存放在主存的用户程序和操作系统，以及所持有的数据，很可能收到CPU上运行的某用户程序的有意或者时无意的破坏。

所以对主存的信息进行严格的加以保护，使得操作系统及其程序不被错误的操作所破坏，这是其系统运行的基本条件之一。

**常用的几种存储保护方法**

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/09.PNG)

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/10.PNG)

### 缓冲技术
缓冲技术主要用于提高CPU利用率

缓冲区是外部设备在进行数据传输期间专门用来暂存数据的主存储区域。

**使用缓冲区的根本原因**：

CPU处理数据的速度与设备传输数据的速度不匹配，因此，需要使用缓冲区来缓解一下期间的速度矛盾。


## 中断技术
#### 中断简介
定义：CPU对系统中发生的异步事件的响应。

异步事件：指无一定时序关系的随即发生的事件。

其它概念:

          中断源（中断事件）：引起中断的那些事件。
          
          中断处理程序：处理中断事件的程序。

#### 中断具有的作用：
（1）能够充分发挥处理机的使用效率

（2）提高系统的实时处理能力。

#### 中断的类型
中断的种类很多，一般按其功能来分为以下几种情况：

            （1）机器故障中断：电源故障中断，机器电路检验错误中断
  
            （2）输入/输出中断：用以反映输入输出设备和通道的数据传输状态，例如：键盘、显示器、鼠标等。
            
            （3）外部中断：如：时钟中断，操作员控制台中断等。
            
            （4）程序性中断:程序中的问题引起的中断，如：溢出中断、错误地使用指令等。
            
            （5）访管中断：是用户程序和操作系统之间唯一相通地门户，用户程序可以通过访管指令引起中断并调用操作系统相应地功能模块为其服务。

而以上的五类中断有颗按中断方式不同可以划分为：

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/11.PNG)


#### 中断优先级
目前多数微型处理机有着多级中断，在多级中断系统中，很可能同时有多个中断请求，此时CPU接受中断优先级为最高地那个中断，忽略其中断优先级最低的中断。

在大型机中，中断优先级按照中断的类型来划分，以机器故障中断的优先级最高，程序中断和访问管理程序中断次之。外部中断再次之，输入输出中断的优先级最低。

#### 中断响应
在计算机中CPU中，CPU在响应中断必须同时满足以下三个条件：

            （1）中断源有中断请求
            （2）CPU允许接受中断请求
            （3）一条指令已经执行完毕，没有开始执行下一条指令（个别情况下允许卡段特殊的长指令的执行）。
            
#### 中断屏蔽

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/12.PNG)

#### 中断处理

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/13.PNG)



