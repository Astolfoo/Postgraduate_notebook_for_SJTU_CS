操作系统的主要运行环境包括系统的硬件环境和由其他的系统软件组成的软件环境，以及操作系统和使用他的人之间的关系。


## 一）中央处理器（CPU）
### 1.单处理器与多处理器系统

单处理器系统：计算机有一个CPU

多处理器系统：计算机有多个CPU。


### 2.CPU的构成与基本工作方式
处理器由运算器、控制器、一系列的寄存器以及高速缓存构成。

      运算器：实现指令中的算术和逻辑运算，是计算机计算的核心。
      
      控制器：负责控制程序运行的流程，包括取指令、维护CPU状态、CPU与内存的交互等。
      
      寄存器：是指令在CPU内部做处理的过程中暂存数据、地址以及指令信息的存储设备，在计算机的存储系统中它具有最快的访问速度。
      
      高速缓存：处于CPU和物理内存之间
           1）.一般由控制器中的内存管理单元（MMU：Memory Management Unit）管理；
           2）.访问速度快于内存，低于寄存器；
           3）.通过高速缓存可以使得CPU的高速指令处理和低速内存访问得以匹配，从而提高CPU的效率。

## 指令系统
每台计算机机器指令的集合称为指令系统，它能够反应一台机器的功能和处理能力，可以分为以下五类：
   
   - 数据处理类指令：用于执行算术和逻辑运算
   - I/O指令：用于启动外围设备，让主存和设备交换数据。
   - 寄存器数据交换类指令：用于在处理器的寄存器和存储器之间交换数据。
   - 控制类指令：如转移，用于改变执行指令序列。
   - 处理器控制指令：修改处理器状态，改变处理器工作方式。
   
专门设计了一系列基本机制：

      具有特权级别的处理器状态，能在不同特权级别运行的各个特权指令。
      硬件机制使得OS可以和普通程序隔离，实现保护和控制。


### 3.处理器中的寄存器

两类寄存器：

   用户可见寄存器（工作寄存器）：由处理器执行的机器语言来引用，通常是对所有的程序都是可用的，包括系统程序和用户程序。
        
        机器语言直接引用
        
        包括了数据寄存器、地址寄存器以及条件码寄存器
        
        数据寄存器(Data Register):又称为通用寄存器，主要用于各种算术逻辑指令和访存指令。
        
        地址寄存器（Address Register）:用于存储数据及指令的物理地址、线性地址或者是有效地址，用于某种特定方式的地址，如索引寄存器（Index Register）、段寄存器（Segment Pointer）、栈指针（Stack Pointer）。
        
        条件码寄存器：保存CPU操作结果的各种标记位，如算术运算过程中产生的溢出、符号等。
        
   控制和状态寄存器：用户控制处理器的操作，大部分对用户是不可见的，由OS的特权代码使用。
        
        用于控制处理器的操作
        
        对于部分用户是不可见的。
        
        一部分可以在某种特权模式（由OS使用）下访问的控制和状态寄存器：
        
        程序计数器（PC，Program Counter）：记录将要取出的指令的地址。
        
        指令寄存器（IR，Instruction Register）：包含最近取出的指令。
        
        程序状态字（PSW，Program Status Word）：记录处理器的运行模式信息等。

## 特权指令和非特权指令
特权指令：只能由操作系统使用的指令。例如：

   - 启动某设备
   - 设置时钟
   - 允许和禁止中断
   - 清内存
   - 在进程之间切换处理机
   - 建立存储保护
   - 存取用于内存保护的寄存器
   - 执行输入输出操作
   - 停止一个CPU的工作
   
非特权指令：在单用户单任务的环境下，不必对指令进行划分。

**用户只能使用非特权指令，只有操作系统OS才可以使用所有的指令（包括非特权指令）。**

使用多道程序设计技术的计算机指令系统必须要区分特权指令和非特权指令。

特权指令一般引起处理器状态的切换：

   - 处理器通过特殊的机制将处理器的状态切换到操作系统运行的特权状态（管态）。
   - 然后将处理权移交给操作系统中的一段特殊代码，这个过程叫做陷入。
   

### 4.处理器的状态       

根据运行程序对资源和机器指令的使用权限将处理器设置为不同的状态：

3.1 多数系统将处理器工作状态划分为**管态**和**目态**。

        管态：操作系统管理程序运行的状态，又称为特权态、系统态、管理态或核心态。
        
        目态：用户程序运行时的状态，又称为普通态或者用户态。
        
3.2 有些系统将处理器状态划分为核心状态、管理状态和用户程序状态（目标状态）三种情况。


**3.3 管态和目态的差别**

处理器处于管态时：

   - 可以执行全部指令（包括特权指令）
   - 可使用所有资源
   - 具有改变处理器状态的能力
   
处理器处于目态时：

   - 只有非特权指令能够执行。

特权级别不同，可运行指令集合就不同。

特权级别越高，可以运行指令集合越大。

搞特权级别对应的可运行指令集合包含低特权级别的。

3.4 管态和目态的切换

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/03.png)

### 5.程序状态字（PSW，Program Status Word）
在PSW中专门设置一位，根据运行程序使用指令的权限而设置：

CPU的工作状态码——————指明管态还是目态，用来说明当前在CPU上执行的是操作系统还是一般用户，从而决定其是否可以使用特权指令或者是拥有其他的特殊权力。

条件码——————反映指令执行后的结果特征

中断屏蔽码————指出是否允许中断。

**5.1 微处理器M68000的程序状态字**

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/04.PNG)

**5.2 微处理器Intel 80386的程序状态字**

![](https://github.com/Soler0502H/Postgraduate_notebook_for_SJTU_Software_Program/blob/master/Images/05.PNG)





